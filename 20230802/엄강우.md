## 캐시 다루기

캐시는 웹 서비스의 성능에 지대한 영향을 끼치는 부분이기에 어떤식으로 다루면 좋은 성능을 보일 수 있을지에 대해 알아 보도록 하겠습니다.

캐시를 효율적으로 다루기 위해서는 `Cache-Control 헤더`를 섬세하게 다루는 것이 중요하며 이에 대해 도움이 될 만한 정보들을 모아 보았습니다.

### 캐시의 생명주기

웹 브라우저에서는 HTTP 요청을 통해 다양한 리소스들을 받아 옵니다. 리소스에 대한 요청을 할 때 처음 받아오는 리소스는 우리가 흔하 아는 HTTP 요청과 응답의 과정을 거치게 됩니다. 이를 완전하다고 표현하겠습니다.

리소스의 생명주기는 응답으로 받은 `Cache-Control 헤더`에 따라 결정됩니다.

#### 캐시의 유효기간

`Cache-Control 헤더`의 값으로 `max-age=<seconds>`를 지정하면 유효시간이 정해집니다.

캐시의 유효기간이 지나기 전이라면 서버에 요청을 보내지 않고 디스크 또는 메모리에서만 캐시를 읽어와 사용합니다.

**서버에 요청을 보내지 않고**라는 말이 굉장히 중요한데 한번 브라우저에 캐시가 저장되면 만료될 때까지는 계속 브라우저에 남아있게 되기 때문입니다. 물론 지우기도 어렵습니다.

#### 캐시의 유효기간이 끝난다면 : 재검증

캐시의 유효기간이 끝났다고 캐시가 바로 사라지는 것은 아니고 브라우저는 서버에 **조건부 요청**을 통해 캐시가 유효한지 재검증을 수행합니다.

그 결과가 유효하다면 **[304 Not Modified]**응답을 받게 되고 HTTP 본문이 포함되지 않은 응답이기에 따르게 내려 받을 수 있습니다.

재검증 요청 헤더에 `If-None-Match`와 `If-Modified-Since`를 포함해서 보낼 수 있습니다.

1. `If-None-Match`

   캐시된 리소스의 `ETag`값과 현재 서버 리소스의 `ETag`값이 같은지 확인합니다.

2. `If-Modified-Since`

   캐시된 리소스의 `Last-Modified`값 이후에 서버 리소스가 수정되어 있는지 확인합니다

`ETag`와 `Last-Modified`값은 기존 캐싱된 리소스의 응답 헤더의 값으로 사용하게 됩니다.

재검증이 실패한다면 **[200 OK]**또는 적합한 상태 코드를 포함하여 본문과 함께 응답을 내려줍니다. 또 다시 요청을 보낼 필요 없으니 굉장히 효율적이라고 볼 수 있습니다.

#### no-cache와 no-store

`no-cache`는 `max-age=0`과 같은 설정입니다. 즉 캐시를 저장은 하지만 사용하려고 할때마다 서버에 재검증 요청을 보내야 합니다.

`no-store`는 캐시를 절대 해서는 안되는 리소스일 때만 사용합니다. 저장조차 하지 말라는 의미입니다.

### 캐시의 위치

CDN과 같은 중간 서버를 이용하며 다양한 곳에 캐시가 생길 수 있습니다.

1. 서버가 가지고 있는 원래 응답을 CDN이 캐시합니다.
2. CDN의 캐시된 응답을 사용자 브라우저가 다시 가져와서 캐시합니다.

이처럼 HTTP 캐시는 여러 레이어에 저장될 수있기 때문에 세심히 다루어야 합니다.

#### CDN Invalidation

일반적으로 CDN의 캐시를 제거하는 것을 의미합니다. 브라우저의 캐시와는 상관 없는 이야기 이며 CDN이 여러개 있는 경우 각 각의 CDN의 캐시를 모두 제거해야하기 때문에 쉬운 작업은 아닙니다. 그래서 `max-age`의 값은 신중히 정해야합니다.

#### Cache-Control : public, private

public은 모든 사람과 중간 서버에서 모두 캐시를 저장할 수 있음을 나타내고

private은 가장 끝의 사용자인 브라우저만 캐시를 저장할 수 있음을 나타냅니다.

#### s-maxage

중간 서버에서만 적용되는 max-age 값을 설정하는 것이며 CDN에서와 브라우저에서의 캐시 생명주기를 따로 설정해 줄 수 있습니다.

### 토스는 어떻게 했을까

#### HTML

`s-maxage=31536000`, `max-age=0` 으로 설정하여 브라우저는 매번 `HTML`을 재검증 요청을 보내고 그 사이 배포가 있으면 새로운 `HTML`을 받게 됩니다.

CDN에는 1년간 캐시 가능하게 하고 새로운 배포가 되면 CDN Invalidation을 통해 CDN이 서버로 부터 새로운 HTML을 받을 수 있도록 합니다.

#### js, css

js파일과 css 파일은 새로이 빌드 했을때 항상 새로 생깁니다. 그리고 각 각의 파일은 매번 임의의 번호로 저장이 되고 그 버전번호를 url 앞에 붙여서 빌드 결과물 마다 고유의 url을 가지도록 되어 있습니다.

그러다 보니 같은 url에 내용물이 바뀔 수 있는 경우는 없고 그러면 리소스의 캐시는 만료될 필요가 없습니다. 그래서 `max-age=31536000`으로 설정합니다.

새로운 배포가 일어나지 않는한 브라우저는 하나의 js파일을 계속 사용하게 됩니다.
